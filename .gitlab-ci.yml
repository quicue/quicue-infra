# Unified quicue CI - validates CUE and exports meta for knowledge graph
stages:
  - validate
  - meta

variables:
  CUE_VERSION: "0.11.1"

.cue-base:
  image: alpine:3.20
  before_script:
    - apk add --no-cache curl
    - curl -fsSL "https://github.com/cue-lang/cue/releases/download/v${CUE_VERSION}/cue_v${CUE_VERSION}_linux_amd64.tar.gz" | tar -xzf - -C /usr/local/bin cue

validate:
  extends: .cue-base
  stage: validate
  script:
    - cue vet ./...
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

meta:export:
  extends: .cue-base
  stage: meta
  script:
    - mkdir -p artifacts/meta
    - |
      for f in meta.cue _meta.cue meta/meta.cue; do
        if [ -f "$f" ]; then
          cue export "$f" --out json > artifacts/meta/project.json
          echo "Exported $f"
          cat artifacts/meta/project.json
          break
        fi
      done
  artifacts:
    paths:
      - artifacts/meta/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
